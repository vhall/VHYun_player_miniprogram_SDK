class t{constructor(){this.END_OF_INPUT=-1,this.base64Chars=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],this.base64Str=null,this.base64Count=null}setBase64Str(t){this.base64Str=t,this.base64Count=0}readBase64(){if(!this.base64Str)return this.END_OF_INPUT;if(this.base64Count>=this.base64Str.length)return this.END_OF_INPUT;const t=255&this.base64Str.charCodeAt(this.base64Count);return this.base64Count+=1,t}encodeBase64(t){let e,i,s="";this.setBase64Str(t);const a=new Array(3);for(e=0,i=!1;!i&&(a[0]=this.readBase64())!==this.END_OF_INPUT;)a[1]=this.readBase64(),a[2]=this.readBase64(),s+=this.base64Chars[a[0]>>2],a[1]!==this.END_OF_INPUT?(s+=this.base64Chars[a[0]<<4&48|a[1]>>4],a[2]!==this.END_OF_INPUT?(s+=this.base64Chars[a[1]<<2&60|a[2]>>6],s+=this.base64Chars[63&a[2]]):(s+=this.base64Chars[a[1]<<2&60],s=`${s}=`,i=!0)):(s+=this.base64Chars[a[0]<<4&48],s=`${s}=`,s=`${s}=`,i=!0),e+=4,e>=76&&(s=`${s}\n`,e=0);return s}}class e{constructor(){this.Base64=new t,this.sessionId=e.random(),this.biz_des02="",this.waitingTimes=0,this.ndi=wx.getSystemInfoSync(),this.logTime={playMessageLogTime:Date.now(),startPlayLogTime:0,stopMessageLogTime:0,pauseMessageLogTime:0},this.streamState={netStatus:{videoBitrate:0,audioBitrate:0,videoFPS:0,videoGOP:0,netSpeed:0,netJitter:0,videoWidth:0,videoHeight:0}},this.playMessageLog=this.playMessageLog.bind(this)}initUpLog(t){this.url=t.url,this.biz_role=t.biz_role,this.biz_id=t.biz_id,this.biz_des01=t.biz_des01,this.biz_des02=t.biz_des02,this.bu=t.bu,this.uid=t.uid,this.aid=t.aid,this.vid=t.vid,this.app_id=t.app_id;let e=this.url.split("/").length>=3?this.url.split("/")[2]:"t-dc.e.vhall.com";this.monitor_url=`https://${e}'/monitor'`}static random(){const t=[1,2,3,4,5,6,7,8,9];return(new Date).valueOf()+String(t[Math.floor(Math.random()*t.length)])+String(t[Math.floor(Math.random()*t.length)])+String(t[Math.floor(Math.random()*t.length)])}static outPutConsole(t,e){console[t](e)}push(t){wx.request({url:t,method:"GET",success:()=>{},fail:t=>{console.error(`uplog failed!! ${t}`)}})}json2base64(t){return this.Base64.encodeBase64(JSON.stringify(t).replace(/\s+/g,"")).replace(/\s+/g,"")}generalMessage(){return{s:this.sessionId,uid:this.uid,aid:this.aid,fd:this.currentPath,sd:this.currentHostname,p:this.aid,pf:"9",ver:"2.0.0",bu:this.bu,vid:this.vid,vfid:this.vid,app_id:this.app_id,ndi:this.ndi,ua:"miniprogram"}}generalPush(t,i){const s=e.random(),a=this.json2base64(i),r=`${this.url}?k=${t}&id=${s}&s=${this.sessionId}&bu=${this.bu}&token=${a}`;this.push(r)}instanceSuccessLog(){let t,e=this.generalMessage();if(delete e.fd,delete e.sd,delete e.p,"live"===this.playType)t=102001;else{if("vod"!==this.playType)return void console.error("type error");t=92001,e.record_id=this.aid}this.generalPush(t,e)}pausePlayLog(){if(Date.now()-this.logTime.pauseMessageLogTime<1e3)return;let t,e=this.generalMessage();"live"==this.playType?(t=102005,e.protocol="flv"):(t=92002,e.record_id=this.aid,e.protocol="hls_domainname"===this.qualityListKeyWords?"hls":"mp4"),this.logTime.pauseMessageLogTime=Date.now(),this.generalPush(t,e)}playMessageLog(){let t,i=this.generalMessage();if(i={...i,bc:this.waitingTimes,bt:0,biz_role:this.biz_role,biz_id:this.biz_id,biz_des01:this.biz_des01,biz_des02:this.biz_des02,bitrate:Math.ceil(this.streamState.netStatus.videoBitrate+this.streamState.netStatus.audioBitrate),errcode:2002,flow_type:2,tf:Math.ceil(30*(this.streamState.netStatus.videoBitrate+this.streamState.netStatus.audioBitrate)*1024/8),tt:Math.ceil((new Date).getTime()-this.logTime.playMessageLogTime),videoWidth:this.streamState.netStatus.videoWidth,videoHeight:this.streamState.netStatus.videoHeight,picture_quality:this.currentQuality,os:!1},"live"===this.playType)t=102002,i.protocol="flv";else{if("vod"!==this.playType)return void e.outPutConsole("error","player Type error");t=92005,i.record_id=this.aid,i.protocol="hls_domainname"===this.qualityListKeyWords?"hls":"mp4"}this.waitingTimes=0,this.logTime.playMessageLogTime=(new Date).getTime(),this.generalPush(t,i)}playErrorMessageLog(t){let i,s=this.generalMessage();if(s={_m:t.detail,...s},"live"===this.playType)i=104001,s.errcode=4001;else{if("vod"!==this.playType)return void e.outPutConsole("error","player Type error");i=94002,s.record_id=this.aid}this.generalPush(i,s)}videoEndMessageLog(){if(Date.now()-this.logTime.stopMessageLogTime<1e3)return;this.logTime.stopMessageLogTime=Date.now();let t=this.generalMessage();t={protocol:"hls_domainname"==this.qualityListKeyWords?"hls":"mp4",record_id:this.aid,...t},this.generalPush(92006,t)}startPlayLog(){if(Date.now(),Date.now()-this.logTime.startPlayLogTime<1e3)return Date.now(),void this.logTime.startPlayLogTime;this.logTime.startPlayLogTime=Date.now();const t="live"==this.playType?102009:92009;let e=this.generalMessage();e={protocol:"live"==this.playType?"flv":"hls_domainname"==this.qualityListKeyWords?"hls":"mp4",record_id:"live"==this.playType?"":this.aid,...e},this.generalPush(t,e)}resumePlayLog(t){let e=this.generalMessage();e={protocol:"flv",...e,fd:t},this.generalPush(102004,e)}waitingLog(){this.waitingTimes++}checkNeedUpload(t=!1){const e=Date.now()-this.logTime.playMessageLogTime;e>3e4&&e<35e3||t?this.playMessageLog():this.logTime.playMessageLogTime=Date.now()}}export default class extends e{constructor(){super(),this.currentHostname="",this.currentPath="",this.dispatchDomain="",this.qualityList=[],this.qualityListKeyWords=null,this.viewUrl={},this.currentQuality=null,this.onNetStatus=this.onNetStatus.bind(this),this.getStreamUrl=this.getStreamUrl.bind(this),this.createInstance=this.createInstance.bind(this)}async createInstance({type:t,token:e,accountId:i,aid:s,appId:a,playerId:r,THIS:o=null,otherOption:h={},defaultQuality:n=null}){if("string"!=typeof a||!a)throw new Error("appId 必须为string且不为空");if("vod"!=t&&"live"!=t)throw new Error("type值 必须为 vod 或者 live");if("string"!=typeof i||!i)throw new Error("accountId 必须为string且不为空");if("string"!=typeof e||!e)throw new Error("token 必须为string且不为空");if("string"!=typeof s||!s)throw new Error("aid 必须为string且不为空");if("string"!=typeof r||!r)throw new Error("playerId 必须为string且不为空");if("object"!=typeof o||!o)throw new Error("THIS 必须为object且不为空");let l;this.playType=t,this.token=e,this.accountId=i,this.aid=s,this.appId=a,this.playerId=r,this.THIS=o,this.defaultQuality=n,h={biz_role:"",biz_id:"",biz_des01:"",biz_des02:"",...h},this.initUpLog({uid:i,aid:s,url:"https://dc.e.vhall.com/login",bu:1,vid:i,app_id:a,...h});try{l=await this.request(this.spliceUrl)}catch(t){return Promise.reject(t)}this.fetchSrc(l.default_server,l.definition),this.dispatchDomain=l.dispatch_server;return this.qualityList=["same","1080p","720p","480p","360p","a"].filter((t=>!!Object.keys(this.viewUrl).includes(t))),this.instanceSuccessLog(),{url:this.currentUrl}}getQualityList(){return this.qualityList}switchQualityLevel(t){if(!this.qualityList.includes(t))return void console.error("无效的清晰度");this.currentQuality=t;const e=`${this.viewUrl[this.currentQuality][0][this.qualityListKeyWords]}?token=${this.streamToken}`;return this.updateHost(e),e}updateHost(t){this.currentHostname=/[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?/.exec(t)[0],this.currentPath=t.split(".com")[1]}fetchSrc({token:t,httpflv_urls:e,hls_domainnames:i,mp4_domainnames:s},a){let r=(t=>{let e=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],i=-1;for(let s=0;s<t.length;s++)i=i>>>8^e[255&(i^t.charCodeAt(s))];return(-1^i)>>>0})(t.split("_")[0].split("").reverse().join("")).toString(16);this.streamToken=r.toUpperCase()+"_"+t.split("_")[1],"live"==this.playType?(this.viewUrl=e,this.qualityListKeyWords="httpflv_url"):i?(a.forEach((t=>{this.viewUrl[t]=[],i.forEach((e=>{let i={hls_domainname:e.hls_domainname,line:e.line};"same"!==t&&(i.hls_domainname=e.hls_domainname.replace(/()\.m3u8$/,`_${t}.m3u8`)),this.viewUrl[t].push(i)}))})),this.qualityListKeyWords="hls_domainname"):(a.forEach((t=>{this.viewUrl[t]=[],s.forEach((e=>{let i={mp4_domainname:"",line:e.line};i.mp4_domainname=e.mp4_domainname,"same"!==t&&(i.mp4_domainname=e.mp4_domainname.replace(/()\.mp4$/,`_${t}.mp4`)),this.viewUrl[t].push(i)}))})),this.qualityListKeyWords="mp4_domainname"),super.qualityListKeyWords=this.qualityListKeyWords}destory(){this.THIS=null}async play(t){(await this.playerContext).play(t),super.startPlayLog()}async pause(t){(await this.playerContext).pause(t),this.checkNeedUpload(!0),this.pausePlayLog()}async resume(t){if("live"!=this.playType)return void e.outPutConsole("warn","video组件无resume方法");(await this.playerContext).resume(t),this.resumePlayLog(this.currentUrl)}async stop(t){(await this.playerContext).stop(t),this.checkNeedUpload(!0),"live"!=this.playType&&this.videoEndMessageLog()}async requestFullScreen(t){(await this.playerContext).requestFullScreen(t)}async exitFullScreen(t){(await this.playerContext).exitFullScreen(t)}async mute(t){if("live"!=this.playType)return void e.outPutConsole("warn","video组件无mute方法");(await this.playerContext).mute(t)}async exitPictureInPicture(t){(await this.playerContext).exitPictureInPicture(t)}async snapshot(t){if("live"!=this.playType)return void e.outPutConsole("warn","video组件无snapshot方法");(await this.playerContext).snapshot(t)}async seek(t){(await this.playerContext).seek(t)}async sendDanmu(t){(await this.playerContext).sendDanmu(t)}async playbackRate(t){(await this.playerContext).playbackRate(t)}async showStatusBar(){(await this.playerContext).showStatusBar()}async hideStatusBar(){(await this.playerContext).hideStatusBar()}async requestBackgroundPlayback(t){(await this.playerContext).requestBackgroundPlayback(t)}async exitBackgroundPlayback(t){(await this.playerContext).exitBackgroundPlayback(t)}onVideoPlay(t){this.startPlayLog(),this.checkNeedUpload()}onVideoPause(t){this.checkNeedUpload(!0),this.pausePlayLog()}onVideoEnd(t){this.videoEndMessageLog()}onVideoError(t){this.playErrorMessageLog(t)}onVideoWaiting(t){}onStateChange(t){switch(t.detail.code){case-2301:case-2302:case-2101:case-2102:case-2107:case 3001:case 3002:case 3003:case 3005:this.playErrorMessageLog(t);break;case 2105:this.waitingLog()}}onNetStatus(t){this.streamState.netStatus=t.detail.info,this.checkNeedUpload()}request(t){return new Promise(((e,i)=>{wx.request({url:t,method:"GET",success:t=>{const s=t.data;if(200!==s.code)return console.error("call sdk api failed, code =",s.code),void i(s);e(s.data)},fail:t=>{console.error("call sdk api failed!!"),i(t)}})}))}delay(t){return new Promise((e=>{setTimeout((()=>{e()}),t)}))}async getStreamUrl(){let t,e="";try{t=await this.request(this.spliceUrl),this.fetchSrc(t.default_server,t.definition),this.dispatchDomain=t.dispatch_server;const i=["same","1080p","720p","480p","360p","a"];this.qualityList=i.filter((t=>!!Object.keys(this.viewUrl).includes(t))),e=this.currentUrl}catch(t){return Promise.reject(t)}return e}get playerContext(){return new Promise((t=>{wx.createSelectorQuery().in(this.THIS).select(`#${this.playerId}`).context().exec((([{context:e}])=>{if(!e)throw new Error(`select #${this.playerId} of null`);t(e)}))}))}get currentUrl(){let t;if(this.currentQuality)t=`${this.viewUrl[this.currentQuality][0][this.qualityListKeyWords]}?token=${this.streamToken}`;else try{t=`${this.viewUrl[this.defaultQuality][0][this.qualityListKeyWords]}?token=${this.streamToken}`,this.currentQuality=this.defaultQuality}catch(e){const i=["same","1080p","720p","480p","360p","a"];for(const e of i)if(this.qualityList.includes(e)){t=`${this.viewUrl[e][0][this.qualityListKeyWords]}?token=${this.streamToken}`,this.currentQuality=e;break}}return this.updateHost(t),t}get spliceUrl(){let t;return t="live"==this.playType?"https://api.vhallyun.com/sdk/v2/room/get-watch-info?client=js&package_check=peter&room_id=":"https://api.vhallyun.com/sdk/v2/demand/get-record-watch-info?client=js&package_check=peter&record_id=",t+`${this.aid}&app_id=${this.appId}&third_party_user_id=${this.accountId}&access_token=${this.token}`}}
